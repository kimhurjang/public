<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/fragment/layout}">
<body>
<th:block layout:fragment="css">
  <link rel="stylesheet" href="/css/reservation.css">
</th:block>

<section layout:fragment="content" id="container" class="reservation list">
  <h1>예약 현황</h1>
  <div id="content" class="content">
    <form th:action="@{/admin/reservation/list}" method="get">
      <div class="form_group">
        <input type="text" name="keyword" th:value="${keyword}" placeholder="회원ID, 이름, 예약자명, 홀, 상태 검색">
        <button type="submit" class="btn color2">검색</button>
      </div>
    </form>

    <style>
      .tbl_type_s01 {table-layout:revert;}
      .tbl_type_s01 th:last-child, td:last-child {width:130px;}
    </style>

    <form th:action="@{/admin/reservation/status}" method="post" id="statusForm">
      <small>전체 수 : <th:block th:text="${paging.totalElements}"></th:block></small>
      <div class="is_wlong_box">
        <table class="tbl_type_s01">
          <colgroup>
            <col style="width:45px">
            <col style="width:60px">
            <col>
          </colgroup>
          <thead>
          <tr>
            <th>No</th>
            <th>회원번호</th>
            <th>예약자</th>
            <th>연락가능한 시간</th>
            <th>행사종류</th>
            <th>행사 예정일</th>
            <th>홀</th>
            <th>인원</th>
            <th>꽃</th>
            <th>식사</th>
            <th>게시일</th>
            <th>관리</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="r, stat : ${paging.content}">
            <td th:text="${paging.totalElements - (pagination.offset + stat.index)}">9</td>
            <td th:text="${r.memberIdx}">101</td>
            <td th:text="${r.name}">홍길동</td>
            <td th:text="${r.contactTime}">25.05.04 / 오후</td>
            <td th:text="${r.eventType}">예식</td>
            <td th:text="${r.eventTimeSelect != null and !r.eventTimeSelect.isEmpty() ? r.eventDate + ' ' + r.eventTimeSelect + '시' : r.eventDate}">25.06.12 10시</td>
            <td th:text="${r.hallName}">리시안셔스</td>
            <td th:text="${r.guestCnt}">100</td>
            <td th:text="${r.flower}">생화</td>
            <td th:text="${r.mealType}">도시락</td>
            <td th:text="${#dates.format(r.createdAt, 'yy.MM.dd HH:mm')}">24.03.09 13:02</td>
            <td>
              <input type="hidden" name="statuses" th:id="'status_' + ${r.idx}" th:value="${r.status}">
              <button type="button" class="btn status_btn small"
                      th:data-idx="${r.idx}"
                      th:data-status="${r.status}"
                      th:text="${r.status}"
                      th:classappend="${r.status == '확정' ? 'color1' : (r.status == '취소' ? 'disabled2' : '')}">
              </button>
              <a th:href="@{/admin/reservation/view(idx=${r.idx})}" class="btn small">보기</a>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </form>

    <div th:replace="~{admin/fragment/paging :: paging}"></div>

    <div class="btn_box mt20">
      <button type="button" id="saveStatusesBtn" class="btn color2">상태변경 저장</button>
    </div>

    <script>
      const statusOrder = ["상담대기", "보류", "확정", "취소"];
      const statusMap = new Map();

      document.querySelectorAll(".status_btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const current = btn.dataset.status;
          const next = statusOrder[(statusOrder.indexOf(current) + 1) % statusOrder.length];
          btn.textContent = next;
          btn.dataset.status = next;
          statusMap.set(btn.dataset.idx, next);
        });
      });

      document.getElementById("saveStatusesBtn").addEventListener("click", () => {
        if (statusMap.size === 0) return alert("변경된 상태가 없습니다.");

        const updates = [...statusMap].map(([idx, status]) => ({ idx, status }));

        fetch("/admin/reservation/status/ajax", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updates)
        })
        .then(res => res.ok ? res.text() : Promise.reject("서버 오류"))
        .then(msg => { alert(msg); location.reload(); })
        .catch(err => alert("상태 변경 실패: " + err));
      });
    </script>

  </div><!--E content-->
</section><!--E container-->

</body>
</html>
